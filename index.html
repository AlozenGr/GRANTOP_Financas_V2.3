<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GRANTOP • Finanças V2.3</title>
  <link rel="icon" type="image/png" href="logo.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background-color: #0f172a; color: #e2e8f0; }
    .card { background: #1e293b; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; }
    .btn { padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; }
    .btn-primary { background: #2563eb; color: white; }
    .btn-danger { background: #dc2626; color: white; }
    .btn-secondary { background: #475569; color: white; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { padding: 0.5rem; border-bottom: 1px solid #334155; }
    th { text-align: left; }
    .hidden { display: none; }
    .badge { padding: 0.2rem 0.6rem; border-radius: 6px; font-size: 0.75rem; font-weight: bold; }
    .badge-green { background: #16a34a; color: white; }
    .badge-red { background: #dc2626; color: white; }
  </style>
</head>
<body class="min-h-screen flex flex-col">

  <!-- TELA DE LOGIN (PIN) -->
  <div id="loginScreen" class="flex-grow flex items-center justify-center">
    <div class="card text-center w-80">
      <img src="logo.png" alt="GRANTOP" class="h-12 mx-auto mb-4" />
      <h2 class="text-lg font-bold mb-2">Acesso restrito</h2>
      <p class="text-sm mb-4">Informe o PIN para entrar.</p>
      <input id="pinInput" type="password" class="w-full p-2 rounded text-black mb-3" placeholder="PIN">
      <button id="loginBtn" class="btn btn-primary w-full">Entrar</button>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div id="appScreen" class="hidden flex-grow flex flex-col">
    <header class="flex justify-between items-center p-4 bg-slate-900 shadow">
      <div class="flex items-center gap-2">
        <img src="logo.png" alt="GRANTOP" class="h-8">
        <h1 class="text-xl font-bold">GRANTOP • Finanças</h1>
        <span id="status" class="ml-2 text-sm text-slate-400">Conectando...</span>
      </div>
      <button id="logoutBtn" class="btn btn-danger text-sm">Sair (PIN)</button>
    </header>

    <main class="p-4 flex-grow">
      <!-- Indicadores -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="card text-center">
          <h3 class="text-sm text-slate-400">Créditos (Total)</h3>
          <p id="cardCreditos" class="text-lg font-bold">R$ 0,00</p>
        </div>
        <div class="card text-center">
          <h3 class="text-sm text-slate-400">Folha (Total)</h3>
          <p id="cardFolha" class="text-lg font-bold">R$ 0,00</p>
        </div>
        <div class="card text-center">
          <h3 class="text-sm text-slate-400">Fixas Pendentes</h3>
          <p id="cardFixas" class="text-lg font-bold">R$ 0,00</p>
        </div>
        <div class="card text-center">
          <h3 class="text-sm text-slate-400">Saldo Previsto</h3>
          <p id="cardSaldo" class="text-lg font-bold">R$ 0,00</p>
        </div>
      </div>

      <!-- Aba Créditos -->
      <div id="abaCreditos" class="card">
        <h2 class="text-lg font-bold mb-2">Créditos (Faturamento)</h2>

        <!-- Formulário -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-4">
          <input id="data" type="date" class="p-2 rounded text-black" placeholder="Data">
          <input id="cliente" type="text" class="p-2 rounded text-black" placeholder="Cliente">
          <input id="servico" type="text" class="p-2 rounded text-black" placeholder="Serviço / Local">
          <input id="valor" type="number" class="p-2 rounded text-black" placeholder="Valor (R$)">
          <select id="pago" class="p-2 rounded text-black">
            <option value="Não">Não</option>
            <option value="Sim">Sim</option>
          </select>
          <input id="obs" type="text" class="p-2 rounded text-black" placeholder="Observações">
        </div>

        <div class="flex gap-2 mb-4">
          <button id="salvarBtn" class="btn btn-primary">Salvar</button>
          <button id="limparBtn" class="btn btn-secondary">Limpar</button>
        </div>

        <!-- Tabela -->
        <table>
          <thead>
            <tr>
              <th>Data</th>
              <th>Cliente</th>
              <th>Serviço</th>
              <th>Valor</th>
              <th>Pago?</th>
              <th>Obs</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="tabelaCreditos"></tbody>
        </table>
      </div>
    </main>
  </div>

  <!-- SCRIPT EMBUTIDO -->
  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxKV_BlnOQgW_hwZwM150o-MjZWfpP5GX-ZSaetQJXwSVnUucNFY9AHGAsM-fVrpitm/exec";
    const TOKEN = "2400";

    const loginScreen = document.getElementById("loginScreen");
    const appScreen = document.getElementById("appScreen");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const pinInput = document.getElementById("pinInput");

    loginBtn.onclick = () => {
      if (pinInput.value === TOKEN) {
        loginScreen.classList.add("hidden");
        appScreen.classList.remove("hidden");
        carregarCreditos();
      } else {
        alert("PIN inválido");
      }
    };

    logoutBtn.onclick = () => {
      appScreen.classList.add("hidden");
      loginScreen.classList.remove("hidden");
      pinInput.value = "";
    };

    async function carregarCreditos() {
      document.getElementById("status").innerText = "Carregando...";
      try {
        const res = await fetch(`${API_URL}?action=listreg&token=${TOKEN}`);
        const json = await res.json();
        if (json.ok) {
          renderCreditos(json.result);
          document.getElementById("status").innerText = "Conectado";
        } else {
          document.getElementById("status").innerText = "Erro ao carregar";
        }
      } catch (err) {
        console.error(err);
        document.getElementById("status").innerText = "Falha de conexão";
      }
    }

    function renderCreditos(lista) {
      const tbody = document.getElementById("tabelaCreditos");
      tbody.innerHTML = "";
      lista.forEach(reg => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${reg.data}</td>
          <td>${reg.cliente}</td>
          <td>${reg.servico}</td>
          <td>R$ ${reg.valor.toFixed(2)}</td>
          <td>
            <span class="badge ${reg.pago === "Sim" ? "badge-green" : "badge-red"}">
              ${reg.pago}
            </span>
          </td>
          <td>${reg.obs}</td>
          <td>
            <button class="btn btn-secondary" onclick="editarCredito(${reg._rowId})">Editar</button>
            <button class="btn btn-danger" onclick="excluirCredito(${reg._rowId})">Excluir</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function excluirCredito(id) {
      if (!confirm("Excluir crédito?")) return;
      const res = await fetch(`${API_URL}?action=delreg&token=${TOKEN}&id=${id}`);
      const json = await res.json();
      if (json.ok) carregarCreditos();
      else alert("Erro ao excluir crédito");
    }

    // salvar
    document.getElementById("salvarBtn").onclick = async () => {
      const payload = {
        data: document.getElementById("data").value,
        cliente: document.getElementById("cliente").value,
        servico: document.getElementById("servico").value,
        valor: parseFloat(document.getElementById("valor").value || 0),
        pago: document.getElementById("pago").value,
        obs: document.getElementById("obs").value
      };
      const res = await fetch(`${API_URL}?action=savereg&token=${TOKEN}&payload=${encodeURIComponent(JSON.stringify(payload))}`);
      const json = await res.json();
      if (json.ok) {
        carregarCreditos();
        document.getElementById("data").value = "";
        document.getElementById("cliente").value = "";
        document.getElementById("servico").value = "";
        document.getElementById("valor").value = "";
        document.getElementById("obs").value = "";
      } else {
        alert("Erro ao salvar crédito");
      }
    };

    // limpar
    document.getElementById("limparBtn").onclick = () => {
      document.getElementById("data").value = "";
      document.getElementById("cliente").value = "";
      document.getElementById("servico").value = "";
      document.getElementById("valor").value = "";
      document.getElementById("obs").value = "";
    };
  </script>
</body>
</html>
