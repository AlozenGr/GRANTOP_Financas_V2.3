/***** GRANTOP_Financas V2.3 — Code.gs (JSONP WebApp focado em Créditos)
 * Compatível com o index.html V2.3 enviado.
 * Endpoints usados pelo front:
 *  - GET ?action=ping
 *  - GET ?action=config
 *  - GET ?action=setmonth&mes=YYYY-MM
 *  - GET ?action=listreg
 *  - GET ?action=savereg&payload=JSON
 *  - GET ?action=delreg&id=ROWINDEX
 *  - GET ?action=resumo
 * Sempre com: token=PUBLIC_TOKEN e callback=<função JSONP>
 *****/

// ===== CONFIG BÁSICA =====
const PUBLIC_TOKEN   = '2400';               // mesmo token do index.html
const PROP_MES_ATUAL = 'MES_ATUAL_ISO';      // yyyy-mm-01 (guardado em DocumentProperties)

// ===== NOMES DE ABAS / CABEÇALHO =====
const ABA_FAT_BASE = 'Faturamento';          // base / fallback
const ABA_RESUMO   = 'Resumo Mensal';

const HEAD_FAT = [
  'Data', 'Cliente', 'Serviço',
  'Preço (opcional)', 'Valor',
  'NF? (Sim/Não)', 'NF (opcional)',
  'Boleto/Recibo', 'Vencimento',
  'Pago? (Sim/Não)', 'Observações'
];

// ===== Helpers Gerais =====
function outputJSONP_(cb, obj){
  const json = JSON.stringify(obj);
  if (cb) return ContentService.createTextOutput(`${cb}(${json})`).setMimeType(ContentService.MimeType.JAVASCRIPT);
  return ContentService.createTextOutput(json).setMimeType(ContentService.MimeType.JSON);
}
function getProps_(){ return PropertiesService.getDocumentProperties(); }

function toMonthStartIso_(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-01`; }
function normalizeMonthInputToIso_(input){
  const s=String(input||'').trim();
  if(/^\d{4}-\d{2}$/.test(s)) return s+'-01';
  if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
  const m=s.match(/^(\d{2})[\/\-\.](\d{4})$/);
  if(m){ const mm=Number(m[1]); if(mm>=1 && mm<=12) return `${m[2]}-${m[1]}-01`; }
  throw new Error('Mês inválido. Use YYYY-MM ou MM/AAAA.');
}
function getMesAtualIso_(){
  const p=getProps_();
  return p.getProperty(PROP_MES_ATUAL) || toMonthStartIso_(new Date());
}
function isoToYYYYMM_(iso){ return String(iso||'').slice(0,7); }
function isoToLabel_(iso){
  const [y,m]=String(iso||'').split('-');
  const nomes=['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
  return `${nomes[Number(m)-1]}/${y}`;
}

function toNumber_(v){
  if(v==='' || v==null) return 0;
  if(typeof v==='number') return v;
  const n = Number(String(v).replace(/\./g,'').replace(',','.'));
  return isNaN(n)?0:n;
}
function toDateFromHtml_(ymd){
  if(!ymd) return '';
  const m=String(ymd).match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if(!m) throw new Error('Data inválida: '+ymd);
  const d=new Date(Number(m[1]), Number(m[2])-1, Number(m[3]));
  if(isNaN(d.getTime())) throw new Error('Data inválida: '+ymd);
  return d;
}
function toYMD_(d){
  if(!(d instanceof Date)) return '';
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

// ===== Sheets Helpers =====
function ss_(){ return SpreadsheetApp.getActive(); }
function ensureSheet_(name){
  const ss=ss_();
  return ss.getSheetByName(name) || ss.insertSheet(name);
}
function ensureHeader_(sh, header){
  const got=sh.getRange(1,1,1,header.length).getValues()[0];
  const empty = got.every(c=>String(c)==='');
  if(empty){ sh.getRange(1,1,1,header.length).setValues([header]); sh.setFrozenRows(1); }
  return sh;
}

// Retorna a aba de faturamento para o YYYY-MM da propriedade MES_ATUAL
function getFatSheetForCurrentMonth_(){
  const iso = getMesAtualIso_();
  const yyyymm = isoToYYYYMM_(iso);
  const ss = ss_();
  const tabName = `${ABA_FAT_BASE} ${yyyymm}`;          // ex.: "Faturamento 2025-09"
  let sh = ss.getSheetByName(tabName);
  if(!sh){
    // tenta fallback "Faturamento"
    sh = ss.getSheetByName(ABA_FAT_BASE);
    if(!sh){
      // cria a com mês
      sh = ss.insertSheet(tabName);
    }else{
      // se existe a base e NÃO existe a do mês, é melhor criar a do mês
      sh = ss.insertSheet(tabName);
    }
  }
  return ensureHeader_(sh, HEAD_FAT);
}

// ====== API: CONFIG / MÊS ======
function api_config(){
  const iso = getMesAtualIso_();
  return {
    mesAtualIso: iso,
    mesAtualYYYYMM: isoToYYYYMM_(iso),
    mesAtualLabel: isoToLabel_(iso),
    spreadsheetId: ss_().getId(),
    tz: Session.getScriptTimeZone()
  };
}
function api_setmonth(mesInput){
  const iso = normalizeMonthInputToIso_(mesInput);
  getProps_().setProperty(PROP_MES_ATUAL, iso);
  // garante a aba do mês
  const sh = getFatSheetForCurrentMonth_();
  sh.autoResizeColumns(1, HEAD_FAT.length);
  return { ok:true, mesAtualIso: iso, mesAtualYYYYMM: isoToYYYYMM_(iso), mesAtualLabel: isoToLabel_(iso) };
}

// ====== API: CRÉDITOS (Faturamento) ======

// Lista os registros da aba do mês atual
function api_listreg(){
  const sh = getFatSheetForCurrentMonth_();
  const last=sh.getLastRow();
  const out=[];
  if(last>=2){
    const vals = sh.getRange(2,1,last-1, Math.max(HEAD_FAT.length, 11)).getValues();
    for(let i=0;i<vals.length;i++){
      const r=vals[i]; if(!r || (r.every(c=>String(c)===''))) continue;
      const rowIndex = 2+i;
      const nfNum   = String(r[6]||'').trim();
      const boleto  = String(r[7]||'').trim();
      const venc    = r[8] instanceof Date ? toYMD_(r[8]) : String(r[8]||'').trim();
      const obsLivre= String(r[10]||'').trim();
      const extra=[]; if(nfNum) extra.push('NF:'+nfNum); if(boleto) extra.push('boleto:'+boleto); if(venc) extra.push('venc:'+venc); if(obsLivre) extra.push(obsLivre);

      out.push({
        _rowId: rowIndex,
        data: (r[0] instanceof Date) ? toYMD_(r[0]) : String(r[0]||''),
        cliente: String(r[1]||''),
        servico: String(r[2]||''),
        valor: Number(r[4])||0,
        pago: String(r[9]||''),
        obs: extra.join(' | ')
      });
    }
  }
  return out;
}

/**
 * Salva registro de crédito
 * payload: { id?:rowIndex, data(yyyy-mm-dd), cliente, servico, valor, pago('Sim'|'Não'), obs('NF:... | boleto:... | venc:yyyy-mm-dd | ...') }
 */
function api_savereg(payload){
  const sh = getFatSheetForCurrentMonth_();
  const dt = payload.data ? toDateFromHtml_(payload.data) : '';
  const val= toNumber_(payload.valor);
  const obsStr = String(payload.obs||'');
  const mNF=obsStr.match(/NF:([^|]+)/i), mL=obsStr.match(/boleto:([^|]+)/i), mV=obsStr.match(/venc:([\d-]+)/i);
  const obsLivre = obsStr.replace(/(?:NF:[^|]+|boleto:[^|]+|venc:[^|]+)\s*\|?\s*/gi,'').trim();

  const linha = [
    dt, payload.cliente||'', payload.servico||'',
    '', val,
    payload.pago==='Sim' ? 'Sim' : 'Não',
    mNF?mNF[1].trim():'', mL?mL[1].trim():'',
    mV?toDateFromHtml_(mV[1].trim()):'',
    payload.pago==='Sim' ? 'Sim' : 'Não',
    obsLivre
  ];

  if(payload.id){
    const row=Number(payload.id);
    if(row<=1 || row>sh.getLastRow()) throw new Error('Linha inválida.');
    sh.getRange(row,1,1,linha.length).setValues([linha]);
    // formatos
    sh.getRange(row,1).setNumberFormat('dd/mm/yyyy');
    sh.getRange(row,9).setNumberFormat('dd/mm/yyyy');
    sh.getRange(row,5).setNumberFormat('R$ #,##0.00');
    return {ok:true, id:row};
  }else{
    sh.appendRow(linha);
    const lr=sh.getLastRow();
    sh.getRange(lr,1).setNumberFormat('dd/mm/yyyy');
    sh.getRange(lr,9).setNumberFormat('dd/mm/yyyy');
    sh.getRange(lr,5).setNumberFormat('R$ #,##0.00');
    return {ok:true, id:lr};
  }
}

function api_delreg(rowIndex){
  const sh = getFatSheetForCurrentMonth_();
  const r=Number(rowIndex);
  if(r<=1 || r>sh.getLastRow()) throw new Error('Linha inválida.');
  sh.deleteRow(r);
  return {ok:true};
}

// ====== API: RESUMO (stub simples) ======
function api_resumo(){
  const sh = ensureSheet_(ABA_RESUMO);
  const iso=getMesAtualIso_(), label=isoToLabel_(iso);
  sh.clear();
  sh.getRange(1,1).setValue('Resumo — '+label).setFontWeight('bold').setFontSize(14);
  sh.setFrozenRows(1);
  return {ok:true};
}

// ====== WEB (JSONP) ======
function doGet(e){
  try{
    const p = e && e.parameter ? e.parameter : {};
    const cb = p.callback || null;

    if (!p.token || p.token !== PUBLIC_TOKEN){
      return outputJSONP_(cb, {ok:false, error:'Unauthorized'});
    }

    const a = String(p.action||'').toLowerCase();
    let result;

    switch(a){
      case 'ping':    result={ok:true,time:new Date()}; break;
      case 'config':  result=api_config(); break;
      case 'setmonth':{
        const mes = p.mes || p.month || p.m;
        result = api_setmonth(mes);
        break;
      }

      // Créditos (Faturamento)
      case 'listreg': result = api_listreg(); break;
      case 'savereg': result = api_savereg( JSON.parse(p.payload||'{}') ); break;
      case 'delreg':  result = api_delreg(p.id); break;

      case 'resumo':  result = api_resumo(); break;

      default:
        throw new Error('Ação inválida');
    }

    return outputJSONP_(cb, {ok:true, result});
  }catch(err){
    const cb = e && e.parameter ? e.parameter.callback : null;
    return outputJSONP_(cb, {ok:false, error:String(err)});
  }
}
